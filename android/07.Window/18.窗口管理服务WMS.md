#### ç›®å½•ä»‹ç»
- 01.Windowçª—å£ä»‹ç»
    - 1.1 Androidçª—å£ç®¡ç†æ¦‚å¿µ
    - 1.2 WindowManagerä»‹ç»
- 02.Windowçš„æ·»åŠ æµç¨‹
- 03.Windowçš„åˆ é™¤æµç¨‹
- 04.Windowçš„æ›´æ–°æµç¨‹



### 01.Windowçª—å£ä»‹ç»
#### 1.1 Androidçª—å£ç®¡ç†æ¦‚å¿µ
- Androidçª—å£ç®¡ç†ä»çª—å£çš„åˆ›å»ºåˆ°UIçš„ç»˜åˆ¶ä¸»è¦æ¶‰åŠä»¥ä¸‹è§’è‰²ï¼š
    - WindowManagerï¼šåº”ç”¨ä¸çª—å£ç®¡ç†æœåŠ¡WindowManagerServiceäº¤äº’çš„æ¥å£
    - WindowManagerServiceï¼šçª—å£ç®¡ç†æœåŠ¡ï¼Œç»§æ‰¿äºIWindowManager.Stubï¼Œæ˜¯Binderçš„æœåŠ¡ç«¯ï¼Œè¯¥æœåŠ¡è¿è¡Œåœ¨ä¸€ä¸ªå•ç‹¬çš„è¿›ç¨‹ä¸­ï¼Œå› æ­¤WindowManagerä¸WindowManagerServiceçš„äº¤äº’ä¹Ÿæ˜¯ä¸€ä¸ªIPCçš„è¿‡ç¨‹ã€‚
    - SurfaceFlingerï¼šSurfaceFlingeræœåŠ¡è¿è¡Œåœ¨Androidç³»ç»Ÿçš„Systemè¿›ç¨‹ä¸­ï¼Œå®ƒè´Ÿè´£ç®¡ç†Androidç³»ç»Ÿçš„å¸§ç¼“å†²åŒºï¼ˆFrame Buffer)ï¼ŒAndroidè®¾å¤‡çš„æ˜¾ç¤ºå±è¢«æŠ½è±¡ä¸ºä¸€ä¸ªå¸§ç¼“å†²åŒºï¼Œè€ŒAndroidç³»ç»Ÿä¸­çš„SurfaceFlingeræœåŠ¡å°±æ˜¯é€šè¿‡å‘è¿™ä¸ªå¸§ç¼“å†²åŒºå†™å…¥å†…å®¹æ¥ç»˜åˆ¶åº”ç”¨ç¨‹åºçš„ç”¨æˆ·ç•Œé¢çš„ã€‚
    - Surfaceï¼šæ¯ä¸ªæ˜¾ç¤ºç•Œé¢çš„çª—å£éƒ½æ˜¯ä¸€ä¸ªSurfaceã€‚
    - PhoneWindowManagerï¼šå®ç°äº†çª—å£çš„å„ç§ç­–ç•¥ã€‚
    - Choreographerï¼šç”¨äºæ§åˆ¶çª—å£åŠ¨ç”»ã€å±å¹•æ—‹è½¬ç­‰æ“ä½œã€‚
    - DisplayContentï¼šç”¨äºæè¿°å¤šå±è¾“å‡ºç›¸å…³ä¿¡æ¯ã€‚
    - WindowStateï¼šæè¿°çª—å£çš„çŠ¶æ€ä¿¡æ¯ä»¥åŠå’ŒWindowManagerServiceè¿›è¡Œé€šä¿¡ï¼Œä¸€èˆ¬ä¸€ä¸ªçª—å£å¯¹åº”ä¸€ä¸ªWindowStateã€‚
    - WindowTokenï¼šçª—å£Tokenï¼Œç”¨æ¥åšBinderé€šä¿¡ã€‚
    - Sessionï¼šé€šä¿¡å¯¹è±¡ï¼ŒAppè¿›ç¨‹é€šè¿‡å»ºç«‹Sessionä»£ç†å¯¹è±¡å’ŒSessionå¯¹è±¡é€šä¿¡ï¼Œè¿›è€Œå’ŒWindowManagerServiceå»ºç«‹è¿æ¥ã€‚
- å‰é¢è¯´åˆ°çª—å£çš„ç®¡ç†æœåŠ¡WindowManagerServiceè¿è¡Œåœ¨SystemServerè¿›ç¨‹ï¼Œæ‰€ä»¥åº”ç”¨è¿›ç¨‹ä¸WindowManagerServiceçš„äº¤äº’æ˜¯ä¸€ä¸ªIPCçš„è¿‡ç¨‹ï¼Œå…·ä½“æµç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š
    - ![image](https://upload-images.jianshu.io/upload_images/4432347-7d8152d17248b823.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
    - å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒActivityæŒæœ‰ä¸€ä¸ªWindowï¼Œè´Ÿè´£UIçš„å±•ç¤ºä¸ç”¨æˆ·äº¤äº’ï¼Œé‡Œä¿å­˜äº†å¾ˆå¤šé‡è¦çš„ä¿¡æ¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
        - mWindowï¼šPhoneWindowå¯¹è±¡ï¼Œç»§æ‰¿äºWindowï¼Œæ˜¯çª—å£å¯¹è±¡ã€‚
        - mWindowManagerï¼šWindowManagerImplå¯¹è±¡ï¼Œå®ç°WindowManageræ¥å£ã€‚
        - mMainThreadï¼šActivityå¯¹è±¡ï¼Œå¹¶éçœŸæ­£çš„çº¿ç¨‹ï¼Œæ˜¯è¿è¡Œåœ¨ä¸»çº¿ç¨‹é‡Œçš„å¯¹è±¡ã€‚
        - mUIThreadï¼šThreadå¯¹è±¡ï¼Œä¸»çº¿ç¨‹ã€‚
        - mHandlerï¼šHandlerå¯¹è±¡ï¼Œä¸»çº¿ç¨‹Handlerã€‚
        - mDecorï¼šViewå¯¹è±¡ï¼Œç”¨æ¥æ˜¾ç¤ºActivityé‡Œçš„è§†å›¾ã€‚
    - ViewRootImplè´Ÿè´£ç®¡ç†DecorViewä¸WindowManagerServiceçš„äº¤äº’ï¼Œæ¯æ¬¡è°ƒç”¨WindowManager.addView()æ·»åŠ çª—å£æ—¶ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªViewRootImplå¯¹è±¡ï¼Œå®ƒå†…éƒ¨ä¹Ÿä¿å­˜äº†ä¸€äº›é‡è¦ä¿¡æ¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
    - mWindowSessionï¼šIWindowSessionå¯¹è±¡ï¼ŒSessionçš„ä»£ç†å¯¹è±¡ï¼Œç”¨æ¥å’ŒSessionè¿›è¡Œé€šä¿¡ï¼ŒåŒä¸€è¿›ç¨‹é‡Œçš„æ‰€æœ‰ViewRootImplå¯¹è±¡åªå¯¹åº”åŒä¸€ä¸ªSessionä»£ç†å¯¹è±¡ã€‚
    - mWindowï¼šIWindow.Stubdå¯¹è±¡ï¼Œæ¯ä¸ªçª—å£å¯¹åº”ä¸€ä¸ªè¯¥å¯¹è±¡ã€‚
- æ³¨ï¼šæ¯ä¸ªActivityå¯¹åº”ä¸€ä¸ªWindowï¼Œæ¯ä¸ªWindowå¯¹åº”ä¸€ä¸ªViewRootImplã€‚


#### 1.2 WindowManagerä»‹ç»
- çª—å£çš„æ“ä½œè¢«å®šä¹‰WindowManagerä¸­ï¼ŒWindowManageræ˜¯ä¸€ä¸ªæ¥å£ï¼Œç»§æ‰¿äºViewManagerï¼Œå®ç°ç±»æ˜¯WindowManagerImplï¼Œå®é™…ä¸Šæˆ‘ä»¬å¸¸ç”¨çš„åŠŸèƒ½ï¼Œä¹Ÿæ˜¯å®šä¹‰åœ¨ViewManageré‡Œçš„ã€‚
    ```java
    public interface ViewManager{
        //æ·»åŠ View
        public void addView(View view, ViewGroup.LayoutParams params);
        //æ›´æ–°View
        public void updateViewLayout(View view, ViewGroup.LayoutParams params);
        //åˆ é™¤View
        public void removeView(View view);
    }
    ```
- WindowManagerå¯ä»¥é€šè¿‡Contextæ¥è·å–ï¼ŒWindowManagerä¹Ÿä¼šå’Œå…¶ä»–æœåŠ¡ä¸€æ ·åœ¨å¼€æœºæ—¶æ³¨å†Œåˆ°ContextImplé‡Œçš„mapå®¹å™¨é‡Œï¼Œç„¶åé€šè¿‡ä»–ä»¬çš„keyæ¥è·å–ã€‚
    ``` java
    windowManager = (WindowManager) getSystemService(Context.WINDOW_SERVICE);
    ```
- WindowManagerçš„å®ç°ç±»æ˜¯WindowManagerImplï¼Œåœ¨WindowManagerImplå†…éƒ¨å®é™…çš„åŠŸèƒ½æ˜¯æœ‰WindowManagerGlobalæ¥å®Œæˆçš„ï¼Œæˆ‘ä»¬ç›´æ¥æ¥åˆ†æå®ƒé‡Œé¢è¿™ä¸‰ä¸ªæ–¹æ³•çš„å®ç°ã€‚



### 02.Windowçš„æ·»åŠ æµç¨‹
- å…·ä½“çœ‹ä¸€ä¸‹ä¸‹é¢çš„ä»£ç 
    ```java
    public final class WindowManagerGlobal {
        
         public void addView(View view, ViewGroup.LayoutParams params,
                    Display display, Window parentWindow) {
                //æ ¡éªŒå‚æ•°çš„åˆæ³•æ€§
                
                //ViewRootImplå°è£…äº†Viewä¸WindowManagerçš„äº¤äº’åŠ›ä¿ƒ
                ViewRootImpl root;
                View panelParentView = null;
        
                synchronized (mLock) {
                    // Start watching for system property changes.
                    if (mSystemPropertyUpdater == null) {
                        mSystemPropertyUpdater = new Runnable() {
                            @Override public void run() {
                                synchronized (mLock) {
                                    for (int i = mRoots.size() - 1; i >= 0; --i) {
                                        mRoots.get(i).loadSystemProperties();
                                    }
                                }
                            }
                        };
                        SystemProperties.addChangeCallback(mSystemPropertyUpdater);
                    }
        
                    int index = findViewLocked(view, false);
                    if (index >= 0) {
                        if (mDyingViews.contains(view)) {
                            // Don't wait for MSG_DIE to make it's way through root's queue.
                            mRoots.get(index).doDie();
                        } else {
                            throw new IllegalStateException("View " + view
                                    + " has already been added to the window manager.");
                        }
                        // The previous removeView() had not completed executing. Now it has.
                    }
        
                    // If this is a panel window, then find the window it is being
                    // attached to for future reference.
                    if (wparams.type >= WindowManager.LayoutParams.FIRST_SUB_WINDOW &&
                            wparams.type <= WindowManager.LayoutParams.LAST_SUB_WINDOW) {
                        final int count = mViews.size();
                        for (int i = 0; i < count; i++) {
                            if (mRoots.get(i).mWindow.asBinder() == wparams.token) {
                                panelParentView = mViews.get(i);
                            }
                        }
                    }
        
                    //é€šè¿‡ä¸Šä¸‹æ–‡æ„å»ºViewRootImpl
                    root = new ViewRootImpl(view.getContext(), display);
        
                    view.setLayoutParams(wparams);
        
                    //mViewså­˜å‚¨ç€æ‰€æœ‰Windowå¯¹åº”çš„Viewå¯¹è±¡
                    mViews.add(view);
                    //mRootså­˜å‚¨ç€æ‰€æœ‰Windowå¯¹åº”çš„ViewRootImplå¯¹è±¡
                    mRoots.add(root);
                    //mParamså­˜å‚¨ç€æ‰€æœ‰Windowå¯¹åº”çš„WindowManager.LayoutParamså¯¹è±¡
                    mParams.add(wparams);
                }
        
                // do this last because it fires off messages to start doing things
                try {
                    //è°ƒç”¨ViewRootImpl.setView()æ–¹æ³•å®ŒæˆWindowçš„æ·»åŠ å¹¶æ›´æ–°ç•Œé¢
                    root.setView(view, wparams, panelParentView);
                } catch (RuntimeException e) {
                    // BadTokenException or InvalidDisplayException, clean up.
                    synchronized (mLock) {
                        final int index = findViewLocked(view, false);
                        if (index >= 0) {
                            removeViewLocked(index, true);
                        }
                    }
                    throw e;
                }
            }
        
    }
    ```
- åœ¨è¿™ä¸ªæ–¹æ³•é‡Œæœ‰ä¸‰ä¸ªé‡è¦çš„æˆå‘˜å˜é‡ï¼š
    - mViewså­˜å‚¨ç€æ‰€æœ‰Windowå¯¹åº”çš„Viewå¯¹è±¡
    - mRootså­˜å‚¨ç€æ‰€æœ‰Windowå¯¹åº”çš„ViewRootImplå¯¹è±¡
    - mParamså­˜å‚¨ç€æ‰€æœ‰Windowå¯¹åº”çš„WindowManager.LayoutParamså¯¹è±¡
    - è¿™é‡Œé¢æåˆ°äº†ä¸€ä¸ªä¸æ˜¯å¾ˆç†Ÿæ‚‰çš„ç±»ViewRootImplï¼Œå®ƒå…¶å®å°±æ˜¯ä¸€ä¸ªå°è£…ç±»ï¼Œå°è£…äº†Viewä¸WindowManagerçš„äº¤äº’æ–¹å¼ï¼Œå®ƒæ˜¯Viewä¸WindowManagerServiceé€šä¿¡çš„æ¡¥æ¢ã€‚æœ€åä¹Ÿæ˜¯è°ƒç”¨ViewRootImpl.setView()æ–¹æ³•å®ŒæˆWindowçš„æ·»åŠ å¹¶æ›´æ–°ç•Œé¢ã€‚
- æ¥çœ‹çœ‹è¿™ä¸ªæ–¹æ³•çš„å®ç°ã€‚
    ```java
    public final class ViewRootImpl implements ViewParent,
            View.AttachInfo.Callbacks, ThreadedRenderer.HardwareDrawCallbacks {
        
         public void setView(View view, WindowManager.LayoutParams attrs, View panelParentView) {
                synchronized (this) {
                    if (mView == null) {
                        mView = view;
        
                        //å‚æ•°æ ¡éªŒä¸é¢„å¤„ç†
                        ...
        
                        // Schedule the first layout -before- adding to the window
                        // manager, to make sure we do the relayout before receiving
                        // any other events from the system.
                        
                        //1. è°ƒç”¨requestLayout()å®Œæˆç•Œé¢å¼‚æ­¥ç»˜åˆ¶çš„è¯·æ±‚
                        requestLayout();
                        if ((mWindowAttributes.inputFeatures
                                & WindowManager.LayoutParams.INPUT_FEATURE_NO_INPUT_CHANNEL) == 0) {
                            mInputChannel = new InputChannel();
                        }
                        mForceDecorViewVisibility = (mWindowAttributes.privateFlags
                                & PRIVATE_FLAG_FORCE_DECOR_VIEW_VISIBILITY) != 0;
                        try {
                            mOrigWindowType = mWindowAttributes.type;
                            mAttachInfo.mRecomputeGlobalAttributes = true;
                            collectViewAttributes();
                            //2. åˆ›å»ºWindowSessionå¹¶é€šè¿‡WindowSessionè¯·æ±‚WindowManagerServiceæ¥å®ŒæˆWindowæ·»åŠ çš„è¿‡ç¨‹
                            //è¿™æ˜¯ä¸€ä¸ªIPCçš„è¿‡ç¨‹ã€‚
                            res = mWindowSession.addToDisplay(mWindow, mSeq, mWindowAttributes,
                                    getHostVisibility(), mDisplay.getDisplayId(),
                                    mAttachInfo.mContentInsets, mAttachInfo.mStableInsets,
                                    mAttachInfo.mOutsets, mInputChannel);
                        } catch (RemoteException e) {
                            mAdded = false;
                            mView = null;
                            mAttachInfo.mRootView = null;
                            mInputChannel = null;
                            mFallbackEventHandler.setView(null);
                            unscheduleTraversals();
                            setAccessibilityFocus(null, null);
                            throw new RuntimeException("Adding window failed", e);
                        } finally {
                            if (restore) {
                                attrs.restore();
                            }
                        }
                        ...
                }
            }    
    }
    ```
- è¿™ä¸ªæ–¹æ³•ä¸»è¦åšäº†ä¸¤ä»¶äº‹ï¼š
    - 1.è°ƒç”¨requestLayout()å®Œæˆç•Œé¢å¼‚æ­¥ç»˜åˆ¶çš„è¯·æ±‚,requestLayout()ä¼šå»è°ƒç”¨scheduleTraversals()æ¥å®ŒæˆViewçš„ç»˜åˆ¶ï¼ŒscheduleTraversals()æ–¹æ³•å°†ä¸€ä¸ªTraversalRunnableæäº¤åˆ°å·¥ä½œé˜Ÿåˆ—ä¸­æ‰§è¡ŒViewçš„ç»˜åˆ¶ã€‚è€ŒTraversalRunnableæœ€ç»ˆè°ƒç”¨äº†performTraversals()æ–¹æ³•æ¥å®Œæˆå®é™…çš„ç»˜åˆ¶æ“ä½œã€‚
    - 2.åˆ›å»ºWindowSessionå¹¶é€šè¿‡WindowSessionè¯·æ±‚WindowManagerServiceæ¥å®ŒæˆWindowæ·»åŠ çš„è¿‡ç¨‹è¿™æ˜¯ä¸€ä¸ªIPCçš„è¿‡ç¨‹ï¼ŒWindowManagerServiceä½œä¸ºå®é™…çš„çª—å£ç®¡ç†è€…ï¼Œçª—å£çš„åˆ›å»ºã€åˆ é™¤å’Œæ›´æ–°éƒ½æ˜¯ç”±å®ƒæ¥å®Œæˆçš„ï¼Œå®ƒåŒæ—¶è¿˜è´Ÿè´£äº†çª—å£çš„å±‚å æ’åºå’Œå¤§å°è®¡ç®—ç­‰å·¥ä½œã€‚
- å…³äºperformTraversals()æ–¹æ³•çš„å®ç°ï¼Œè¿™é‡Œæˆ‘ä»¬å†ç®€å•æä¸€ä¸‹ï¼š
    - 1.è·å–Surfaceå¯¹è±¡ï¼Œç”¨äºå›¾å½¢ç»˜åˆ¶ã€‚
    - 2.è°ƒç”¨performMeasure()æ–¹æ³•æµ‹é‡è§†å›¾æ ‘å„ä¸ªViewçš„å¤§å°ã€‚
    - 3.è°ƒç”¨performLayout()æ–¹æ³•è®¡ç®—è§†å›¾æ ‘å„ä¸ªViewçš„ä½ç½®ï¼Œè¿›è¡Œå¸ƒå±€ã€‚
    - 4.è°ƒç”¨performMeasure()æ–¹æ³•å¯¹è§†å›¾æ ‘çš„å„ä¸ªViewè¿›è¡Œç»˜åˆ¶ã€‚
- æ—¢ç„¶æåˆ°WindowManagerä¸WindowManagerServiceçš„è·¨è¿›ç¨‹é€šä¿¡ï¼Œæˆ‘ä»¬å†è®²ä¸€ä¸‹å®ƒä»¬çš„é€šä¿¡æµç¨‹ã€‚Androidçš„å„ç§æœåŠ¡éƒ½æ˜¯åŸºäºC/Sç»“æ„æ¥è®¾è®¡çš„ï¼Œç³»ç»Ÿå±‚æä¾›æœåŠ¡ï¼Œåº”ç”¨å±‚ä½¿ç”¨æœåŠ¡ã€‚WindowManagerä¹Ÿæ˜¯ä¸€æ ·ï¼Œå®ƒä¸
WindowManagerServiceçš„é€šä¿¡æ˜¯é€šè¿‡WindowSessionæ¥å®Œæˆçš„ã€‚
    - 1.é¦–å…ˆè°ƒç”¨ServiceManager.getService("window")è·å–WindowManagerServiceï¼Œè¯¥æ–¹æ³•è¿”å›çš„æ˜¯IBinderå¯¹è±¡ï¼Œç„¶åè°ƒç”¨IWindowManager.Stub.asInterface()æ–¹æ³•å°†WindowManagerServiceè½¬æ¢ä¸ºä¸€ä¸ªIWindowManagerå¯¹è±¡ã€‚
    - 2.ç„¶åè°ƒç”¨openSession()æ–¹æ³•ä¸WindowManagerServiceå»ºç«‹ä¸€ä¸ªé€šä¿¡ä¼šè¯ï¼Œæ–¹ä¾¿åç»­çš„è·¨è¿›ç¨‹é€šä¿¡ã€‚è¿™ä¸ªé€šä¿¡ä¼šè¯å°±æ˜¯åé¢æˆ‘ä»¬ç”¨åˆ°çš„WindowSessionã€‚
- åŸºæœ¬ä¸Šæ‰€æœ‰çš„Androidç³»ç»ŸæœåŠ¡éƒ½æ˜¯åŸºäºè¿™ç§æ–¹å¼å®ç°çš„ï¼Œå®ƒæ˜¯ä¸€ç§åŸºäºAIDLå®ç°çš„IPCçš„è¿‡ç¨‹ã€‚
    - å…³äºaidlå¯ä»¥çœ‹æˆ‘çš„è¿™ç¯‡åšå®¢ï¼š[Aidlè¯¦ç»†ä»‹ç»](https://github.com/yangchong211/YCBlogs)
    ```java
    public final class WindowManagerGlobal {
        
        public static IWindowSession getWindowSession() {
            synchronized (WindowManagerGlobal.class) {
                if (sWindowSession == null) {
                    try {
                        InputMethodManager imm = InputMethodManager.getInstance();
                        //è·å–WindowManagerServiceå¯¹è±¡ï¼Œå¹¶å°†å®ƒè½¬æ¢ä¸ºIWindowManagerç±»å‹
                        IWindowManager windowManager = getWindowManagerService();
                        //è°ƒç”¨openSession()æ–¹æ³•ä¸WindowManagerServiceå»ºç«‹ä¸€ä¸ªé€šä¿¡ä¼šè¯ï¼Œæ–¹ä¾¿åç»­çš„
                        //è·¨è¿›ç¨‹é€šä¿¡ã€‚
                        sWindowSession = windowManager.openSession(
                                new IWindowSessionCallback.Stub() {
                                    @Override
                                    public void onAnimatorScaleChanged(float scale) {
                                        ValueAnimator.setDurationScale(scale);
                                    }
                                },
                                imm.getClient(), imm.getInputContext());
                    } catch (RemoteException e) {
                        throw e.rethrowFromSystemServer();
                    }
                }
                return sWindowSession;
            }
        }
        
        public static IWindowManager getWindowManagerService() {
            synchronized (WindowManagerGlobal.class) {
                if (sWindowManagerService == null) {
                    //è°ƒç”¨ServiceManager.getService("window")è·å–WindowManagerServiceï¼Œè¯¥æ–¹æ³•è¿”å›çš„æ˜¯IBinderå¯¹è±¡
                    //ï¼Œç„¶åè°ƒç”¨IWindowManager.Stub.asInterface()æ–¹æ³•å°†WindowManagerServiceè½¬æ¢ä¸ºä¸€ä¸ªIWindowManagerå¯¹è±¡
                    sWindowManagerService = IWindowManager.Stub.asInterface(
                            ServiceManager.getService("window"));
                    try {
                        sWindowManagerService = getWindowManagerService();
                        ValueAnimator.setDurationScale(sWindowManagerService.getCurrentAnimatorScale());
                    } catch (RemoteException e) {
                        throw e.rethrowFromSystemServer();
                    }
                }
                return sWindowManagerService;
            }
        }
     }
    ```


### 03.Windowçš„åˆ é™¤æµç¨‹
- Windowçš„åˆ é™¤æµç¨‹ä¹Ÿæ˜¯åœ¨WindowManagerGlobalé‡Œå®Œæˆçš„ã€‚
    ```java
    public final class WindowManagerGlobal {
        
       public void removeView(View view, boolean immediate) {
            if (view == null) {
                throw new IllegalArgumentException("view must not be null");
            }
    
            synchronized (mLock) {
                //1. æŸ¥æ‰¾å¾…åˆ é™¤Viewçš„ç´¢å¼•
                int index = findViewLocked(view, true);
                View curView = mRoots.get(index).getView();
                //2. è°ƒç”¨removeViewLocked()å®ŒæˆViewçš„åˆ é™¤, removeViewLocked()æ–¹æ³•
                //ç»§ç»­è°ƒç”¨ViewRootImpl.die()æ–¹æ³•æ¥å®ŒæˆViewçš„åˆ é™¤ã€‚
                removeViewLocked(index, immediate);
                if (curView == view) {
                    return;
                }
    
                throw new IllegalStateException("Calling with view " + view
                        + " but the ViewAncestor is attached to " + curView);
            }
        }
        
        private void removeViewLocked(int index, boolean immediate) {
            ViewRootImpl root = mRoots.get(index);
            View view = root.getView();
    
            if (view != null) {
                InputMethodManager imm = InputMethodManager.getInstance();
                if (imm != null) {
                    imm.windowDismissed(mViews.get(index).getWindowToken());
                }
            }
            boolean deferred = root.die(immediate);
            if (view != null) {
                view.assignParent(null);
                if (deferred) {
                    mDyingViews.add(view);
                }
            }
        }
    
    }
    ```
- å†æ¥çœ‹çœ‹ViewRootImpl.die()æ–¹æ³•çš„å®ç°ã€‚
    ```java
    public final class ViewRootImpl implements ViewParent,
    
            View.AttachInfo.Callbacks, ThreadedRenderer.HardwareDrawCallbacks {
          boolean die(boolean immediate) {
                // Make sure we do execute immediately if we are in the middle of a traversal or the damage
                // done by dispatchDetachedFromWindow will cause havoc on return.
                
                //æ ¹æ®immediateå‚æ•°æ¥åˆ¤æ–­æ˜¯æ‰§è¡Œå¼‚æ­¥åˆ é™¤è¿˜æ˜¯åŒæ­¥åˆ é™¤
                if (immediate && !mIsInTraversal) {
                    doDie();
                    return false;
                }
        
                if (!mIsDrawing) {
                    destroyHardwareRenderer();
                } else {
                    Log.e(mTag, "Attempting to destroy the window while drawing!\n" +
                            "  window=" + this + ", title=" + mWindowAttributes.getTitle());
                }
                //å¦‚æœæ˜¯å¼‚æ­¥åˆ é™¤ï¼Œåˆ™å‘é€ä¸€ä¸ªåˆ é™¤Viewçš„æ¶ˆæ¯MSG_DIEå°±ä¼šç›´æ¥è¿”å›
                mHandler.sendEmptyMessage(MSG_DIE);
                return true;
            }
        
            void doDie() {
                checkThread();
                if (LOCAL_LOGV) Log.v(mTag, "DIE in " + this + " of " + mSurface);
                synchronized (this) {
                    if (mRemoved) {
                        return;
                    }
                    mRemoved = true;
                    if (mAdded) {
                        //è°ƒç”¨dispatchDetachedFromWindow()å®ŒæˆViewçš„åˆ é™¤
                        dispatchDetachedFromWindow();
                    }
        
                    if (mAdded && !mFirst) {
                        destroyHardwareRenderer();
        
                        if (mView != null) {
                            int viewVisibility = mView.getVisibility();
                            boolean viewVisibilityChanged = mViewVisibility != viewVisibility;
                            if (mWindowAttributesChanged || viewVisibilityChanged) {
                                // If layout params have been changed, first give them
                                // to the window manager to make sure it has the correct
                                // animation info.
                                try {
                                    if ((relayoutWindow(mWindowAttributes, viewVisibility, false)
                                            & WindowManagerGlobal.RELAYOUT_RES_FIRST_TIME) != 0) {
                                        mWindowSession.finishDrawing(mWindow);
                                    }
                                } catch (RemoteException e) {
                                }
                            }
        
                            mSurface.release();
                        }
                    }
        
                    mAdded = false;
                }
                //åˆ·æ–°æ•°æ®ï¼Œå°†å½“å‰ç§»é™¤Viewçš„ç›¸å…³ä¿¡æ¯ä»æˆ‘ä»¬ä¸Šé¢è¯´è¿‡äº†ä¸‰ä¸ªåˆ—è¡¨ï¼šmRootsã€mParmså’ŒmViewsä¸­ç§»é™¤ã€‚
                WindowManagerGlobal.getInstance().doRemoveView(this);
            }
            
            void dispatchDetachedFromWindow() {
                    //1. å›è°ƒViewçš„dispatchDetachedFromWindowæ–¹æ³•ï¼Œé€šçŸ¥è¯¥Viewå·²ä»Windowä¸­ç§»é™¤
                    if (mView != null && mView.mAttachInfo != null) {
                        mAttachInfo.mTreeObserver.dispatchOnWindowAttachedChange(false);
                        mView.dispatchDetachedFromWindow();
                    }
            
                    mAccessibilityInteractionConnectionManager.ensureNoConnection();
                    mAccessibilityManager.removeAccessibilityStateChangeListener(
                            mAccessibilityInteractionConnectionManager);
                    mAccessibilityManager.removeHighTextContrastStateChangeListener(
                            mHighContrastTextManager);
                    removeSendWindowContentChangedCallback();
            
                    destroyHardwareRenderer();
            
                    setAccessibilityFocus(null, null);
            
                    mView.assignParent(null);
                    mView = null;
                    mAttachInfo.mRootView = null;
            
                    mSurface.release();
            
                    if (mInputQueueCallback != null && mInputQueue != null) {
                        mInputQueueCallback.onInputQueueDestroyed(mInputQueue);
                        mInputQueue.dispose();
                        mInputQueueCallback = null;
                        mInputQueue = null;
                    }
                    if (mInputEventReceiver != null) {
                        mInputEventReceiver.dispose();
                        mInputEventReceiver = null;
                    }
                    
                    //è°ƒç”¨WindowSession.remove()æ–¹æ³•ï¼Œè¿™åŒæ ·æ˜¯ä¸€ä¸ªIPCè¿‡ç¨‹ï¼Œæœ€ç»ˆè°ƒç”¨çš„æ˜¯
                    //WindowManagerService.removeWindow()æ–¹æ³•æ¥ç§»é™¤Windowã€‚
                    try {
                        mWindowSession.remove(mWindow);
                    } catch (RemoteException e) {
                    }
            
                    // Dispose the input channel after removing the window so the Window Manager
                    // doesn't interpret the input channel being closed as an abnormal termination.
                    if (mInputChannel != null) {
                        mInputChannel.dispose();
                        mInputChannel = null;
                    }
            
                    mDisplayManager.unregisterDisplayListener(mDisplayListener);
            
                    unscheduleTraversals();
                }
    
    }
    ```
- æ¥æ€»ç»“ä¸€ä¸‹Windowçš„åˆ é™¤æµç¨‹ï¼š
    - 1.æŸ¥æ‰¾å¾…åˆ é™¤Viewçš„ç´¢å¼•
    - 2.è°ƒç”¨removeViewLocked()å®ŒæˆViewçš„åˆ é™¤,removeViewLocked()æ–¹æ³•ç»§ç»­è°ƒç”¨ViewRootImpl.die()æ–¹æ³•æ¥å®ŒæˆViewçš„åˆ é™¤ã€‚
    - 3.ViewRootImpl.die()æ–¹æ³•æ ¹æ®immediateå‚æ•°æ¥åˆ¤æ–­æ˜¯æ‰§è¡Œå¼‚æ­¥åˆ é™¤è¿˜æ˜¯åŒæ­¥åˆ é™¤ï¼Œå¦‚æœæ˜¯å¼‚æ­¥åˆ é™¤åˆ™åˆ™å‘é€ä¸€ä¸ªåˆ é™¤Viewçš„æ¶ˆæ¯MSG_DIEå°±ä¼šç›´æ¥è¿”å›ã€‚å¦‚æœæ˜¯åŒæ­¥åˆ é™¤ï¼Œåˆ™è°ƒç”¨doDie()æ–¹æ³•ã€‚
    - 4.doDie()æ–¹æ³•è°ƒç”¨dispatchDetachedFromWindow()å®ŒæˆViewçš„åˆ é™¤ï¼Œåœ¨è¯¥æ–¹æ³•é‡Œé¦–å…ˆå›è°ƒViewçš„dispatchDetachedFromWindowæ–¹æ³•ï¼Œé€šçŸ¥è¯¥Viewå·²ä»Windowä¸­ç§»é™¤ï¼Œç„¶åè°ƒç”¨WindowSession.remove()æ–¹æ³•ï¼Œè¿™åŒæ ·æ˜¯ä¸€ä¸ªIPCè¿‡ç¨‹ï¼Œæœ€ç»ˆè°ƒç”¨çš„æ˜¯WindowManagerService.removeWindow()æ–¹æ³•æ¥ç§»é™¤Windowã€‚



### 04.Windowçš„æ›´æ–°æµç¨‹
- ä»£ç å¦‚ä¸‹æ‰€ç¤º
    ```java
    public final class WindowManagerGlobal {
        
        public void updateViewLayout(View view, ViewGroup.LayoutParams params) {
            if (view == null) {
                throw new IllegalArgumentException("view must not be null");
            }
            if (!(params instanceof WindowManager.LayoutParams)) {
                throw new IllegalArgumentException("Params must be WindowManager.LayoutParams");
            }
    
            final WindowManager.LayoutParams wparams = (WindowManager.LayoutParams)params;
    
            //æ›´æ–°Viewçš„LayoutParamså‚æ•°
            view.setLayoutParams(wparams);
    
            synchronized (mLock) {
                //æŸ¥æ‰¾Viewdçš„ç´¢å¼•ï¼Œæ›´æ–°mParamsé‡Œçš„å‚æ•°
                int index = findViewLocked(view, true);
                ViewRootImpl root = mRoots.get(index);
                mParams.remove(index);
                mParams.add(index, wparams);
                //è°ƒç”¨ViewRootImpl.setLayoutParams()å®Œæˆé‡æ–°å¸ƒå±€çš„å·¥ä½œã€‚
                root.setLayoutParams(wparams, false);
            }
        }   
    }
    ```
- å†æ¥çœ‹çœ‹ViewRootImpl.setLayoutParams()æ–¹æ³•çš„å®ç°ã€‚
    ```java
    public final class ViewRootImpl implements ViewParent,
    
       void setLayoutParams(WindowManager.LayoutParams attrs, boolean newView) {
               synchronized (this) {
                   //å‚æ•°é¢„å¤„ç†
                   ...
       
                    //å¦‚æœæ˜¯æ–°Viewï¼Œè°ƒç”¨requestLayout()è¿›è¡Œé‡æ–°ç»˜åˆ¶
                   if (newView) {
                       mSoftInputMode = attrs.softInputMode;
                       requestLayout();
                   }
       
                   // Don't lose the mode we last auto-computed.
                   if ((attrs.softInputMode & WindowManager.LayoutParams.SOFT_INPUT_MASK_ADJUST)
                           == WindowManager.LayoutParams.SOFT_INPUT_ADJUST_UNSPECIFIED) {
                       mWindowAttributes.softInputMode = (mWindowAttributes.softInputMode
                               & ~WindowManager.LayoutParams.SOFT_INPUT_MASK_ADJUST)
                               | (oldSoftInputMode & WindowManager.LayoutParams.SOFT_INPUT_MASK_ADJUST);
                   }
       
                   mWindowAttributesChanged = true;
                   //å¦‚æœä¸æ˜¯æ–°Viewï¼Œè°ƒç”¨requestLayout()è¿›è¡Œé‡æ–°ç»˜åˆ¶
                   scheduleTraversals();
               }
           } 
    }
    ```
- Windowçš„æ›´æ–°æµç¨‹ä¹Ÿå’Œå…¶ä»–æµç¨‹ç›¸ä¼¼ï¼š
    - 1.æ›´æ–°Viewçš„LayoutParamså‚æ•°ï¼ŒæŸ¥æ‰¾Viewdçš„ç´¢å¼•ï¼Œæ›´æ–°mParamsé‡Œçš„å‚æ•°ã€‚
    - 2.è°ƒç”¨ViewRootImpl.setLayoutParams()æ–¹æ³•å®Œæˆé‡æ–°å¸ƒå±€çš„å·¥ä½œï¼Œåœ¨setLayoutParams()æ–¹æ³•é‡Œæœ€ç»ˆä¼šè°ƒç”¨scheduleTraversals()è¿›è¡Œè§£ç é‡ç»˜åˆ¶ï¼ŒscheduleTraversals()åç»­çš„æµç¨‹å°±æ˜¯Viewçš„measureã€layoutå’Œdrawæµç¨‹äº†ï¼Œè¿™ä¸ªæˆ‘ä»¬åœ¨ä¸Šé¢å·²ç»è¯´è¿‡äº†ã€‚
- é€šè¿‡ä¸Šé¢åˆ†æï¼Œæˆ‘ä»¬äº†è§£äº†Windowçš„æ·»åŠ ã€åˆ é™¤å’Œæ›´æ–°æµç¨‹ã€‚é‚£ä¹ˆæˆ‘ä»¬æ¥æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼šæ—¢ç„¶è¯´æ˜¯Windowçš„æ·»åŠ ã€åˆ é™¤å’Œæ›´æ–°ï¼Œé‚£ä¸ºä»€ä¹ˆæ–¹æ³•åæ˜¯addViewã€updateViewLayoutã€removeViewï¼ŒWindowçš„æœ¬è´¨æ˜¯ä»€ä¹ˆï¼ŸğŸ¤”
    - äº‹å®ä¸ŠWindowæ˜¯ä¸€ä¸ªæŠ½è±¡çš„æ¦‚å¿µï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒå¹¶ä¸æ˜¯å®é™…å­˜åœ¨çš„ï¼Œå®ƒä»¥Viewçš„å½¢å¼å­˜åœ¨ï¼Œæ¯ä¸ªWindowéƒ½å¯¹åº”ç€ä¸€ä¸ªViewå’Œä¸€ä¸ªViewRootImplï¼ŒWindowä¸Viewé€šè¿‡ViewRootImplæ¥å»ºç«‹è”ç³»ã€‚æ¨è€Œå¹¿ä¹‹ï¼Œæˆ‘ä»¬å¯ä»¥ç†è§£WindowManagerServiceå®é™…ç®¡ç†çš„ä¹Ÿä¸æ˜¯Windowï¼Œè€Œæ˜¯Viewï¼Œç®¡ç†åœ¨å½“å‰çŠ¶æ€ä¸‹å“ªä¸ªViewåº”è¯¥åœ¨æœ€ä¸Šå±‚æ˜¾ç¤ºï¼ŒSurfaceFlingerç»˜åˆ¶ä¹ŸåŒæ ·æ˜¯Viewã€‚




### å…¶ä»–ä»‹ç»
#### 01.å…³äºåšå®¢æ±‡æ€»é“¾æ¥
- 1.[æŠ€æœ¯åšå®¢æ±‡æ€»](https://www.jianshu.com/p/614cb839182c)
- 2.[å¼€æºé¡¹ç›®æ±‡æ€»](https://blog.csdn.net/m0_37700275/article/details/80863574)
- 3.[ç”Ÿæ´»åšå®¢æ±‡æ€»](https://blog.csdn.net/m0_37700275/article/details/79832978)
- 4.[å–œé©¬æ‹‰é›…éŸ³é¢‘æ±‡æ€»](https://www.jianshu.com/p/f665de16d1eb)
- 5.[å…¶ä»–æ±‡æ€»](https://www.jianshu.com/p/53017c3fc75d)



#### 02.å…³äºæˆ‘çš„åšå®¢
- githubï¼šhttps://github.com/yangchong211
- çŸ¥ä¹ï¼šhttps://www.zhihu.com/people/yczbj/activities
- ç®€ä¹¦ï¼šhttp://www.jianshu.com/u/b7b2c6ed9284
- csdnï¼šhttp://my.csdn.net/m0_37700275
- å–œé©¬æ‹‰é›…å¬ä¹¦ï¼šhttp://www.ximalaya.com/zhubo/71989305/
- å¼€æºä¸­å›½ï¼šhttps://my.oschina.net/zbj1618/blog
- æ³¡åœ¨ç½‘ä¸Šçš„æ—¥å­ï¼šhttp://www.jcodecraeer.com/member/content_list.php?channelid=1
- é‚®ç®±ï¼šyangchong211@163.com
- é˜¿é‡Œäº‘åšå®¢ï¼šhttps://yq.aliyun.com/users/article?spm=5176.100- 239.headeruserinfo.3.dT4bcV
- segmentfaultå¤´æ¡ï¼šhttps://segmentfault.com/u/xiangjianyu/articles
- æ˜é‡‘ï¼šhttps://juejin.im/user/5939433efe88c2006afa0c6e




